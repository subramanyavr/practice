<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetSuite AI Mode - Dynamic Task Lists + Guide Launch</title>
    <style>
        :root {
            --bg: #0f1c3a;
            --card-bg: #1a2a4a;
            --text: #e0e8ff;
            --text-light: #a0b0d0;
            --accent: #4a90e2;
            --border: #2a3a5a;
            --green: #2ecc71;
            --yellow: #f1c40f;
            --red: #e74c3c;
        }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }
        .panel {
            width: 360px;
            height: 100vh;
            background: var(--bg);
            padding: 16px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            font-size: 18px;
            font-weight: 600;
        }
        .header .star { font-size: 24px; }
        .tab {
            background: #2a3a5a;
            border-radius: 20px 20px 0 0;
            padding: 8px 16px;
            cursor: pointer;
        }
        .tab.active { background: var(--card-bg); }
        .tab .badge {
            background: #e63946;
            color: white;
            border-radius: 50%;
            font-size: 11px;
            padding: 2px 6px;
            margin-left: 6px;
        }
        .intro {
            margin-bottom: 24px;
        }
        .intro h2 { font-size: 20px; margin: 0 0 8px; line-height: 1.3; }
        .intro p { font-size: 14px; color: var(--text-light); margin: 0; }
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
        }
        .card-header .toggle { font-size: 20px; color: var(--text-light); }
        .progress {
            background: #34495e;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
        .card-content {
            padding: 0 16px 16px;
            font-size: 14px;
            color: var(--text-light);
            display: none;
        }
        .card-content.open { display: block; }
        .task-list { list-style: none; padding: 0; margin: 12px 0 0; }
        .task-item {
            padding: 10px 0;
            border-top: 1px solid var(--border);
        }
        .task-item:first-child { border-top: none; }
        .guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        .guide-header:hover { color: white; background: rgba(255,255,255,0.05); border-radius: 4px; padding: 8px; margin: -8px -8px; }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .completed { background: var(--green); }
        .pending { background: var(--yellow); }
        .guide-type {
            color: #ffcc00;
            font-weight: bold;
            margin-left: 8px;
            font-size: 11px;
        }
        .reset-tasklist-btn {
            background: var(--red);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }
        .reset-tasklist-btn:hover { background: #c0392b; }
        .guide-desc {
            display: none;
            font-size: 13px;
            color: #b0c4de;
            margin-top: 6px;
            padding-left: 32px;
        }
        .guide-desc.open { display: block; }
        .footer {
            margin-top: 32px;
            text-align: center;
        }
        .reset-all-btn {
            background: var(--red);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .reset-all-btn:hover { background: #c0392b; }
        .completed-message {
            text-align: center;
            padding: 60px 20px;
            color: #aaa;
        }
        .completed-message h3 {
            margin: 0 0 12px;
            color: var(--green);
        }
    </style>
</head>
<body>
    <div class="panel">
        <div class="header">
            <span class="star">â˜…</span>
            <div class="tab active">What's new</div>
            <div class="tab">To-do list <span class="badge">2</span></div>
        </div>

        <div class="intro">
            <h2>Learn how NetSuite AI Mode works with these key experiences</h2>
            <p>Learn how to navigate through this new UI, so you can get the info you need to start working.</p>
        </div>

        <div id="dynamic-tasklists">
            <!-- Content will be rendered here -->
        </div>

        <div class="footer">
            <button class="reset-all-btn" onclick="resetAllTaskLists()">Reset All Progress</button>
        </div>
    </div>

    <script>
        let taskListsData = [];

        // Guide type icons (emoji â€“ can be replaced with SVG/icons later)
        const guideTypeIcons = {
            'TKL': 'ðŸ“‹',      // Task List
            'SRV': 'ðŸ“‹',      // Survey
            'TRC': 'ðŸ”—',      // Trigger / Tour / Link
            'LNK': 'ðŸ”—',      // Link
            'MSG': 'ðŸ’¬',      // Message / Tip
            'WAL': 'ðŸš¶',      // Walkthrough
            'TUT': 'ðŸŽ“',      // Tutorial
            'VID': 'ðŸŽ¥',      // Video
            'default': 'â­'
        };

        function getGuideIcon(type = 'default') {
            return guideTypeIcons[type.toUpperCase()] || guideTypeIcons.default;
        }

        function toggleTaskList(header, apiName, isOpening) {
            const content = header.nextElementSibling;
            content.classList.toggle('open');
            header.querySelector('.toggle').textContent = content.classList.contains('open') ? 'â–²' : 'â–¼';

            if (typeof iridize === 'function') {
                const eventName = isOpening ? 'flexTasklistOpened' : 'flexTasklistClosed';
                iridize('api.guide.notifyHostEvent', { eventName, apiName });
            }
        }

        function toggleGuideDescription(el) {
            const desc = el.nextElementSibling;
            desc.classList.toggle('open');
        }

        function launchGuide(taskListApiName, guideApiName) {
            if (typeof iridize === 'function') {
                iridize('api.guide.startFlexTasklistGuide', {
                    taskListApiName,
                    launchedGuideApiName: guideApiName
                });
                console.log(`Launching: ${guideApiName} in tasklist ${taskListApiName}`);
            } else {
                console.warn("iridize not available");
            }
        }

        function getProgress(taskList) {
            const total = taskList.taskListItems?.length || 0;
            const done = taskList.taskListItems?.filter(g => g.completed)?.length || 0;
            return `${done}/${total}`;
        }

        function renderTaskLists(taskLists) {
            taskListsData = Array.isArray(taskLists) ? taskLists : [];
            const container = document.getElementById('dynamic-tasklists');
            container.innerHTML = '';

            const realTaskLists = taskListsData.filter(t => t.guideType === 'TKL' && t.apiName);

            if (realTaskLists.length === 0) {
                container.innerHTML = `
                    <div class="completed-message">
                        <h3>All tasks completed ðŸŽ‰</h3>
                        <p>You've finished everything available right now.</p>
                    </div>
                `;
                return;
            }

            realTaskLists.forEach((taskList, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.apiName = taskList.apiName;

                const header = document.createElement('div');
                header.className = 'card-header';
                header.innerHTML = `
                    <span>
                        ${getGuideIcon('TKL')} ${taskList.displayName || taskList.apiName}
                        <span class="progress">${getProgress(taskList)}</span>
                    </span>
                    <div style="display:flex; gap:12px; align-items:center;">
                        <button class="reset-tasklist-btn"
                            onclick="event.stopPropagation(); resetTaskList('${taskList.apiName}', this.closest('.card'))">
                            Reset
                        </button>
                        <span class="toggle">${index === 0 ? 'â–²' : 'â–¼'}</span>
                    </div>
                `;

                header.onclick = (e) => {
                    if (e.target.tagName === 'BUTTON') return;
                    const isOpening = !header.nextElementSibling.classList.contains('open');
                    toggleTaskList(header, taskList.apiName, isOpening);
                };

                const content = document.createElement('div');
                content.className = 'card-content';
                if (index === 0) content.classList.add('open');

                content.innerHTML = `
                    <p>${taskList.description || 'No description available'}</p>
                    <ul class="task-list"></ul>
                `;

                const ul = content.querySelector('.task-list');

                (taskList.taskListItems || []).forEach(guide => {
                    const li = document.createElement('li');
                    li.className = 'task-item';

                    const icon = getGuideIcon(guide.guideType);
                    const statusClass = guide.completed ? 'completed' : 'pending';
                    const isLinkType = ['TRC','LNK','LINK'].includes((guide.guideType || '').toUpperCase());

                    let guideHTML = '';

                    if (isLinkType && guide.url) {
                        guideHTML = `
                            <a href="${guide.url}" target="_blank" rel="noopener noreferrer"
                               style="color:var(--accent); text-decoration:none; display:flex; align-items:center; gap:10px; flex:1;">
                                ${icon}
                                <strong>${guide.displayName || guide.apiName}</strong>
                                <span class="guide-type">[${guide.guideType}]</span>
                            </a>
                        `;
                    } else {
                        guideHTML = `
                            <div style="display:flex; align-items:center; gap:10px; flex:1; cursor:pointer;"
                                 onclick="handleGuideClick('${taskList.apiName}', '${guide.apiName}', this)">
                                <div class="status-dot ${statusClass}"></div>
                                ${icon}
                                <strong>${guide.displayName || guide.apiName}</strong>
                                <span class="guide-type">[${guide.guideType}]</span>
                            </div>
                        `;
                    }

                    li.innerHTML = `
                        <div class="guide-header">
                            ${guideHTML}
                            <span class="toggle" style="font-size:16px;">â–¼</span>
                        </div>
                        <div class="guide-desc">${guide.description || 'No description'}</div>
                    `;

                    ul.appendChild(li);
                });

                card.appendChild(header);
                card.appendChild(content);
                container.appendChild(card);
            });
        }

        function handleGuideClick(taskListApiName, guideApiName, el) {
            toggleGuideDescription(el);
            launchGuide(taskListApiName, guideApiName);
        }

        function resetTaskList(apiName, cardElement) {
            if (typeof iridize !== 'function') {
                alert("iridize not available â€“ UI reset only");
                resetUIForTaskList(cardElement);
                return;
            }
            iridize('api.taskList.reset', { apiNames: [apiName] }, (success) => {
                if (success === true) {
                    resetUIForTaskList(cardElement);
                } else {
                    alert("Reset failed");
                }
            });
        }

        function resetUIForTaskList(cardElement) {
            cardElement.querySelectorAll('.status-dot').forEach(dot => {
                dot.className = 'status-dot pending';
            });
            const card = cardElement.closest('.card');
            if (card) {
                const taskList = taskListsData.find(t => t.apiName === card.dataset.apiName);
                if (taskList) {
                    taskList.taskListItems.forEach(g => g.completed = false);
                    card.querySelector('.progress').textContent = getProgress(taskList);
                }
            }
        }

        function resetAllTaskLists() {
            if (taskListsData.length === 0) return;
            const apiNames = taskListsData
                .filter(t => t.guideType === 'TKL' && t.apiName)
                .map(t => t.apiName);

            if (apiNames.length === 0) return alert("No task lists to reset");

            if (typeof iridize !== 'function') {
                alert("iridize not available â€“ UI reset only");
                document.querySelectorAll('.card').forEach(resetUIForTaskList);
                return;
            }

            iridize('api.taskList.reset', { apiNames }, (success) => {
                if (success === true) {
                    document.querySelectorAll('.card').forEach(resetUIForTaskList);
                    alert("All task lists reset");
                } else {
                    alert("Bulk reset failed");
                }
            });
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        //  Load real data on every page load
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function loadFlexGuides() {
            if (typeof iridize !== 'function') {
                document.getElementById('dynamic-tasklists').innerHTML =
                    '<div class="completed-message" style="color:#e74c3c;"><h3>iridize SDK not loaded</h3></div>';
                return;
            }

            iridize("api.onReady", {}, () => {
                console.log("iridize ready â†’ fetching flex guides");
                iridize("api.guide.getFlexGuides", {}, (data) => {
                    console.log("getFlexGuides â†’", data);
                    renderTaskLists(data);
                });
            });
        }

        // Start loading when page is ready
        window.addEventListener('load', loadFlexGuides);

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        //  OGL / iridize loader (your original part â€“ kept as-is)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getOglParam(name, defaultValue = null) {
            const urlParams = new URLSearchParams(window.location.search);
            let value = urlParams.get(name);
            if (value !== null) localStorage.setItem(`ogl_${name}`, value);
            return value !== null ? value : (localStorage.getItem(`ogl_${name}`) || defaultValue);
        }

        const appId = getOglParam('ogl_appid', "evw1zYvfTtWJ3gRR8G2bug");
        let baseUrl = getOglParam('ogl_url', "guidedlearning.oracle.com");
        const envType = (getOglParam('ogl_env_type') || '').toLowerCase();
        const endUser = getOglParam('ogl_end_user');

        baseUrl = baseUrl.replace(/^https?:\/\//, '').replace(/\/+$/, '');

        let envMode = null;
        if (envType === 'dev' || envType === 'development' || envType === 'stage') envMode = 'dev';
        else if (envType === 'uat' || envType === 'test') envMode = 'uat';

        window.iridize = window.iridize || function(e,t,n){return iridize.api.call(e,t,n);};
        iridize.api = iridize.api || {q:[],call:function(e,t,n){iridize.api.q.push({method:e,data:t,callback:n});}};
        iridize.appId = appId;
        if (envMode) iridize.env = envMode;

        (function(){
            var s = document.createElement("script");
            s.src = `https://${baseUrl}/player/latest/static/js/iridizeLoader.min.js`;
            s.type = "text/javascript";
            s.async = true;
            s.onload = function() {
                console.log("[flexUX] OGL loaded â†’ user:", endUser || "(not set)");
                if (typeof iridize === 'function' && endUser) {
                    iridize("api.fields.set", { user_id: endUser });
                }
                // Try to load guides again after loader is ready
                setTimeout(loadFlexGuides, 800);
            };
            (document.body || document.head).appendChild(s);
        })();
    </script>
</body>
</html>
